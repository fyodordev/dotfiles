#!/usr/bin/env bash
set -euo pipefail

# sync — borg snapshot then rclone bisync
# Pass --if-changed to skip when nothing changed (used by systemd timer)

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
. "$SCRIPT_DIR/cloud-sync.conf"

# --if-changed: skip if no local files changed since last sync
if [[ "${1:-}" == "--if-changed" ]] && [[ -f "$MARKER_FILE" ]]; then
    if ! find "$LOCAL_PATH" -newer "$MARKER_FILE" \
         -not -name "$CHECK_FILENAME" -print -quit | grep -q .; then
        echo "==> No local changes since last sync, skipping"
        exit 0
    fi
fi

# Wait for network: indefinitely on first boot (no marker), 5s otherwise
if [[ -f "$MARKER_FILE" ]]; then
    /usr/lib/systemd/systemd-networkd-wait-online --any --quiet --timeout 5 \
        || { echo "==> No network, skipping"; exit 0; }
else
    echo "==> Waiting for network..."
    /usr/lib/systemd/systemd-networkd-wait-online --any --quiet
fi

# Acquire an exclusive lock — exit immediately if another sync is running
exec 9>"$LOCKFILE"
flock --nonblock 9 || { echo "Another sync is already running"; exit 1; }

echo "==> Creating borg snapshot of $LOCAL_PATH"
borg create \
    --compression zstd \
    "$BORG_REPO::sync-{now:%Y-%m-%dT%H:%M:%S}" \
    "$LOCAL_PATH"

echo "==> Pruning old snapshots"
borg prune \
    --keep-hourly 24 \
    --keep-daily 14 \
    --keep-weekly 8 \
    --keep-monthly 12 \
    --keep-yearly -1 \
    "$BORG_REPO"
borg compact "$BORG_REPO"

echo "==> Running bisync"
rclone bisync "$LOCAL_PATH/" "$RCLONE_REMOTE" \
    --check-access               `# verify both sides are reachable via CHECK_FILENAME` \
    --check-filename "$CHECK_FILENAME" \
    --max-delete "$MAX_DELETE"    `# abort if deletions exceed this percentage` \
    --resilient                   `# handle minor transient errors without aborting` \
    --recover                     `# automatically recover from a prior interrupted bisync`

touch "$MARKER_FILE"
echo "==> Sync complete"
